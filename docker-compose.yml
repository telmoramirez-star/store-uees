services:
    # 1. SERVICIO DE LA APLICACIÓN LARAVEL (PHP-FPM)
    app:
        # Usa la imagen que SUBISTE a Docker Hub. ¡Esto contiene todo el código!
        image: xramirezuees/shopping-car-uees:latest 
        container_name: laravel_app
        restart: always
        # Las variables de entorno son cruciales para la configuración
        environment:
            # Base de Datos
            DB_CONNECTION: mysql
            DB_HOST: db                    # Nombre del servicio de la DB
            DB_PORT: 3306
            DB_DATABASE: laravel_db
            DB_USERNAME: user
            DB_PASSWORD: password123
            # App
            APP_ENV: production            # Recomendado para imágenes distribuidas
            APP_KEY: base64:TuClaveDeAplicacionGeneradaAqui
            APP_DEBUG: 'false'
        
        # Este comando se ejecuta después de que el contenedor de la DB esté listo
        depends_on:
            - db
        # Comando para configurar y ejecutar la aplicación (sigue siendo necesario)
        command: >
            bash -c "php artisan key:generate --force && 
                     php artisan config:clear && 
                     php artisan migrate --force && 
                     php artisan db:seed --force && 
                     php-fpm"

    # 2. SERVICIO DE LA BASE DE DATOS (MYSQL)
    db:
        image: mysql:8.0
        container_name: mysql_db
        restart: always
        environment:
            MYSQL_DATABASE: laravel_db
            MYSQL_USER: user
            MYSQL_PASSWORD: password123
            MYSQL_ROOT_PASSWORD: rootpassword
        volumes:
            - dbdata:/var/lib/mysql # Persistencia de los datos
    
    # 3. SERVICIO DEL SERVIDOR WEB (NGINX)
    nginx:
        image: nginx:stable-alpine
        container_name: laravel_nginx
        restart: always
        ports:
            - "80:80" # Mapea el puerto 80 del host al 80 del contenedor
        depends_on:
            - app
        # Aquí montamos solo la configuración de NGINX, no el código fuente de Laravel.
        # Sin embargo, NGINX necesita acceder al código de la imagen `app`.
        # Para que esto funcione, necesitas montar un volumen compartido.
        volumes:
            # Montar la configuración de NGINX (Asumiendo que tienes una carpeta nginx/conf.d/)
            - ./nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf 
            # ¡CLAVE! Aquí necesitamos montar el código de la imagen de Laravel 
            # de alguna manera. Como el código está dentro de la imagen, la forma más sencilla
            # es que la imagen NGINX y la imagen APP accedan a la misma ubicación, 
            # pero sin el montaje de código local.
            # 
            # SOLUCIÓN ALTERNATIVA (Recomendada para Imágenes):
            # Usar un *Entrypoint* en la imagen APP para copiar los archivos estáticos
            # o incluir una imagen NGINX que ya sepa cómo comunicarse con la imagen APP.
            # 
            # *Para este caso de uso donde solo se baja el compose, la mejor práctica es
            # definir un Entrypoint o simplificar el Dockerfile de la APP.*
            
            # Dejaremos la configuración de NGINX separada, asumiendo que el usuario
            # sí debe tener la carpeta `nginx/conf.d/default.conf`.
            # Si esto es un problema, se podría crear una imagen NGINX propia con la configuración interna.
            
# VOLÚMENES para persistir datos de la DB
volumes:
    dbdata:
        driver: local